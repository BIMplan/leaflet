<html>
<head>
  <title>Leaflet Floor Plan</title>
  <link rel="stylesheet" href="css/leaflet.css" />
<!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.6.4/leaflet.ie.css" />
  <![endif]-->
  <script src="js/jquery-3.1.0.min.js"></script>
  <script src="js/underscore-min.js"></script>
  <script src="js/leaflet.js"></script>
  <script src="js/Leaflet.ImageOverlay.Rotated.js"></script>
  <style>
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0;}
      #map {
	      height: 100%;
	      width: 80%;
	      border: 1px solid #000000;
	      float: left;
	  }
	  #text {
		  float: left;
		  width: 200px;
		  padding: 10px;
		  font-family: sans-serif;
		  font-size: 14px;
	  }
	  #text ul strong {
		  color: #ff0000;
	  }
  </style>
</head>
<body>

  <div id="map"></div>
  <div id="text">
	  <h2>Leaflet-GeoJSON</h2>Interactive floor plans generated with GeoJSON data web services from the <a href="http://onuma.com" target="_blank">ONUMA Cloud Server</a>.
	  <ul>
		  <li>Select or de-select layers from the layer popup on the top-right.</li>
		  <li>Background maps can be selected when zooming out far enough.</li>
		  <li><strong>Click on spaces to load components dynamically.</strong></li>
		  <li>At some point when zooming out, components are being turned off.</li>
	  </ul>
	  <h4>GeoJSON web service requests for this plan:</h4>
	  <p id="urlRequests"></p>
  </div>
  <script>
//get url parameters
var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;
    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : sParameterName[1];
        }
    }
};

var types={};
var floorID = getUrlParameter('floorID');
var spaceID = getUrlParameter('spaceID');
var png = getUrlParameter('png');
var siteID = getUrlParameter('siteID');
var sysID = getUrlParameter('sysID');

var geojsonRequests1 = "<ul>"
					+ "<li>"
					+ "<a href='https://www.onuma.com/plan/OPS/export/saveGeoJSON.php?sysID=" + sysID + "&siteID=" + siteID + "&object=sites' target='_blank'>Current Site</a>"
					+ "</li>"
					+ "<li>"
					+ "<a href='https://www.onuma.com/plan/OPS/export/saveGeoJSON.php?sysID=" + sysID + "&siteID=" + siteID + "&object=buildings' target='_blank'>Buildings on Site</a>"
					+ "</li>";
if(floorID){
var geojsonRequests2 = "<li>"
					+ "<a href='https://www.onuma.com/plan/OPS/export/saveGeoJSON.php?sysID=" + sysID + "&siteID=" + siteID + "&object=floors&floorID=" + floorID + "' target='_blank'>Current Floor</a>"
					+ "</li>"
					+ "<li>"
					+ "<a href='https://www.onuma.com/plan/OPS/export/saveGeoJSON.php?sysID=" + sysID + "&siteID=" + siteID + "&object=spaces&floorID=" + floorID + "' target='_blank'>Current Spaces</a>"
					+ "</li>"
					+ "</ul>";
}else{
var geojsonRequests2 = "</ul>";
}
var geojsonRequests = geojsonRequests1.concat(geojsonRequests2);
document.getElementById("urlRequests").innerHTML = geojsonRequests;

if(png == 0){
  png="";
}else if (L.Browser.safari || L.Browser.gecko) {
  png="";
}else{
  png=1;
}

// initialize the map / set it to max Zoom of OpenStreetMap if no floors are shown
// var map = L.map('map').setView([47.55895, -122.34165], 21);
if(floorID){
	var map = L.map('map');
}else{
	var map = L.map('map', {
		maxZoom: 19
	});
}
// add various tile layers
var Esri_WorldStreet = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012'
});

var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
});

var OpenStreetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
	maxZoom: 19,
	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
});

var None = L.tileLayer('', {
	maxZoom: 28,
	attribution: ''
});

var MapBox = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
	attribution: 'Imagery from <a href="https://mapbox.com/about/maps/">MapBox</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
	id: 'thomasdalbert.14l14pcc',
	accessToken: 'pk.eyJ1IjoidGhvbWFzZGFsYmVydCIsImEiOiJjaXJ3cTZod3QwMDBqMnNsaHVlaWFtdjUzIn0.k68dm3gA3LSyuhD-IfHioA'
});

// show OpenStreetMap if no floors are shown
if(!floorID){
	OpenStreetMap.addTo(map);
}

var baseMaps = {
    "None": None,
    "Mapbox": MapBox,
    "Open Street Map":OpenStreetMap,
    "ESRI Satellite":Esri_WorldImagery,
    "ESRI Street":Esri_WorldStreet
};
var control=L.control.layers(baseMaps).addTo(map);
  
var getPopupContent = function(feature) {
    var formatLinks=function(links) {
        return _.map(links, function(v) {
            if (v.type && v.type=='file') {
                if (v.url) {
                    return '<a href="' + v.url + '" target="_blank">' + v.name + '</a>';
                } else {
                    return v.name;
                }
            } else if (v.type && v.type=='image') {
                if (v.url) {
                    return '<a href="' + v.url + '" target="_blank"><img src="' + v.url + '" border="0" style="width:120px;" /></a>';
                } else {
                    return v.name;
                }
            } else {
                return v;
            }
        }).join('<br />');
    }
    var formatV=function(v) {

        if (v.type && v.type=='link') {

        }
    }
    var properties={'id':feature.id};
    _.each(feature.properties, function(v,k) {
        if (k=='name' || k=='imageName') return;
        if (!v) return;
        if (Array.isArray(v) && v.length==0) return;
        if (k=='links') {
            properties[k]=formatLinks(v);
            return;
        }
        properties[k]=v;
    });
    var str='';
    str+='<table>'+(_.map(properties, function(v,k) { return '<tr><td valign="top">'+k+':</td><td valign="top">'+v+'<td></tr>'; }).join(''))+'</table>';



    return str;
}
//popup for all properties
var popUp =function(feature,layer){
    if (feature.properties){
        if (feature.properties.featureType=='Component') {
            var title='<h2>'+(feature.properties.unique_mark?feature.properties.unique_mark+' - ':'')+feature.properties.name+'</h2>';
            var componentContent=getPopupContent(feature);
            if (feature.properties.typeId) {
                var type=types[feature.properties.typeId];
                componentContent+='<h2>'+type.properties.name+'</h2>';
                componentContent+=getPopupContent(type);
            }
            layer.bindPopup(title+componentContent);
        } else {
            layer.bindPopup(function() {
                var title='<h2>'+(feature.properties.number?feature.properties.number+' - ':'')+feature.properties.name+'</h2>';
                var content=title+getPopupContent(feature);
                if (feature.properties.featureType=='Space' && !loaded[feature.id]) {
                    content+='<a href="javascript:;" onclick="loadComponents('+feature.id+');">Load components</a>';
                }
                return content;
            });
        }
    }

};

var loaded={};
var loadComponents=function(spaceID) {
    $('.leaflet-popup').remove();
    $.ajax({
        url: "https://www.onuma.com/plan/OPS/export/saveGeoJSON.php?sysID=" + sysID + "&siteID=" + siteID + "&object=components&floorID=" + floorID + '&spaceID=' + spaceID,
        jsonp: "callback",
        dataType: "jsonp",
        success: function (response) {
            loaded[spaceID]=true;
            var layer;
            // manually parse geojson, create overlays and insert into layer
            if (png) {
                var components = _.map(response.features, function (f) {
                    return createComponentOverlay(f, map);
                });
                var polygons = _.map(response.features, function (f) {
                    return createComponentPolygon(f, map);
                });
                layer = L.layerGroup(components.concat(polygons)).setZIndex(z);
            } else {
                layer = L.geoJson(response, overlayParams).setZIndex(z);
            }
            componentLayer.addLayer(layer);
        }
    });
};

var homeIcon = L.icon({
    iconUrl: 'home.png',
    iconSize: [27,21]
});
  
var polygonstyle = function(feature){
      var fillColor, opacity=0.6, color="#000";
      if (feature.properties.featureType=='Site') {
          fillColor = '#43a2ca';
      } else if (feature.properties.featureType=='Building') {
          fillColor = '#99f';
      } else if (feature.properties.featureType=='Floor') {
          fillColor = '#99f';
      } else if (feature.properties.featureType=='Component') {
          // polygon for components that don't use the PNGs (Firefox, Safari)
          opacity=0.3;
          color=fillColor = '#00f';
      } else if (feature.properties.featureType=='Space') {
          number = feature.properties.number;
          if ( number == 101 ) fillColor = "#006837";
          else if ( number == 201 ) fillColor = "#31a354";
          else if ( number == 102 ) fillColor = "#78c679";
          else if ( number == 202 ) fillColor = "#c2e699";
          else if ( number == 203 ) fillColor = "#ffffcc";
          else fillColor = "#f7f7f7";  // no data
      }
      return { color: color, weight: 0.8, fillColor: fillColor, fillOpacity: opacity };
};
   
var buildingmarker = function(feature,coord){
    var marker = L.marker(coord,{icon: homeIcon});
    return marker;
};

var createComponentOverlay=function(feature, map) {
    var polyline = feature.geometry.coordinates[0];
    var topleft    = L.latLng(polyline[3][1],polyline[3][0]),
        topright   = L.latLng(polyline[2][1],polyline[2][0]),
        bottomleft = L.latLng(polyline[0][1],polyline[0][0]);
    var imageName=(feature.properties.imageName?feature.properties.imageName:'Rectangle.png');
    var overlay=L.imageOverlay.rotated('furnBitmaps/'+imageName, topleft, topright, bottomleft, { pane:'markerPane', opacity:1 });
    return overlay;
};
var createComponentPolygon=function(feature, map) {
    var polyline = feature.geometry.coordinates[0];
    var polygon = L.polygon(_.map(polyline, function(p) { return [p[1],p[0]]; }), {color: '#fff', opacity:0.01});
    popUp(feature,polygon);
    return polygon;
};

var addOverlay = function (url, layerName, params,z) {
    $.ajax({url:url,
        jsonp: "callback",
        dataType: "jsonp",
        success: function( response ) {
            var layer = L.geoJson(response, params).setZIndex(z).addTo(map);
            control.addOverlay(layer, layerName);
            if (layerName=='Site') {
                var arr = response.features[0].geometry.coordinates[0];
                var latlngs = _.map(arr, function(elem) { return [elem[1],elem[0]]; });
                var polygon = L.polygon(latlngs);
                map.fitBounds(polygon.getBounds(),{
	                //padding: [2,2]
                });
            }
        }});

};

L.control.scale({
	//metric: false,
	//maxWidth: 500
}).addTo(map);

var overlayParams={
	dataType:"jsonp",
	onEachFeature:popUp,
    style: polygonstyle,
	pointToLayer: buildingmarker
};



addOverlay("https://www.onuma.com/plan/OPS/export/saveGeoJSON.php?sysID=" + sysID + "&siteID=" + siteID + "&object=sites", 'Site', overlayParams, 410);
addOverlay("https://www.onuma.com/plan/OPS/export/saveGeoJSON.php?sysID=" + sysID + "&siteID=" + siteID + "&object=buildings", 'Building', overlayParams,420);
addOverlay("https://www.onuma.com/plan/OPS/export/saveGeoJSON.php?sysID=" + sysID + "&siteID=" + siteID + "&object=floors&floorID=" + floorID, 'Floor', overlayParams,430);
addOverlay("https://www.onuma.com/plan/OPS/export/saveGeoJSON.php?sysID=" + sysID + "&siteID=" + siteID + "&object=spaces&floorID=" + floorID, 'Space', overlayParams,440);

// finish loading types before starting to load components
$.ajax({
    url: "https://www.onuma.com/plan/OPS/export/saveGeoJSON.php?sysID=" + sysID + "&siteID=" + siteID + "&object=types",
    jsonp: "callback",
    dataType: "jsonp",
    success: function (response) {
        _.each(response.attributes, function(type) {
           types[type.id]=type;
        });
    },
});
// manually add component layer
var componentLayer, z=1000, layerName='Components';
// manually parse geojson, create overlays and insert into layer
componentLayer = L.layerGroup([]).setZIndex(z).addTo(map);
control.addOverlay(componentLayer, layerName);
map.on('zoomend', function() {
    if (map.getZoom() < 19 && map.hasLayer(componentLayer)){
        console.log('removed');
        map.removeLayer(componentLayer);
    }
    if (map.getZoom() >= 19 && !map.hasLayer(componentLayer)){
        console.log('added');
        map.addLayer(componentLayer);
    }
});



  </script>
</body>
</html>
	